openapi: 3.0.3
info:
  title: IAMService API - Sistema IAM Completo
  description: |
    IAMService API - Sistema IAM (Identity and Access Management) completo para gerenciar autenticação, usuários e cargos. API REST moderna construída com NestJS e TypeScript.

    ## Fluxo de Autenticação
    1. **Registro**: `POST /api/auth/register` - Cria nova conta
    2. **Login**: `POST /api/auth/login` - Retorna access + refresh tokens
    3. **Refresh**: `POST /api/auth/refresh` - Renova access token
    4. **Uso**: Inclua `Authorization: Bearer <access_token>` nas requisições

    ## Reset de Senha
    1. **Solicitar Reset**: `POST /api/auth/requestPasswordReset` - Gera token de reset de senha
    2. **Resetar Senha**: `POST /api/auth/resetPassword` - Valida token e atualiza senha
  version: 1.0.0
  contact:
    name: API Support
    email: jpm.work.prog@gmail.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Servidor de desenvolvimento
  - url: https://jp-auth-service-6c3a177d9759.herokuapp.com
    description: Servidor de produção

tags:
  - name: Auth
    description: Endpoints de autenticação e autorização
  - name: Users
    description: Operações CRUD de usuários

paths:
  /api/auth/register:
    post:
      tags:
        - Auth
      summary: Registrar novo usuário
      description: Cria uma nova conta de usuário no sistema
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterDto"
            examples:
              user_example:
                summary: Registro de usuário comum
                value:
                  name: "João Silva"
                  email: "joao@example.com"
                  password: "MinhaSenh@123"
              admin_example:
                summary: Registro de administrador
                value:
                  name: "Admin User"
                  email: "admin@example.com"
                  password: "AdminSenh@123"
                  role: "ADMIN"
      responses:
        "201":
          description: Usuário criado com sucesso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthSuccessResponse"
              example:
                user:
                  id: "cmibv831y00035comthf3wzmk"
                  name: "João Silva"
                  email: "joao@example.com"
                  role: "USER"
                  createdAt: "2024-01-15T10:30:00Z"
                  updatedAt: "2024-01-15T10:30:00Z"
                accessToken: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                refreshToken: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                expiresIn: 900
        "400":
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"
              example:
                statusCode: 400
                message:
                  - "email must be a valid email"
                  - "password must be longer than or equal to 8 characters"
                error: "Bad Request"
        "409":
          description: Email já cadastrado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
              example:
                statusCode: 409
                message: "Email already exists"
                error: "Conflict"

  /api/auth/login:
    post:
      tags:
        - Auth
      summary: Fazer login
      description: Autentica usuário e retorna tokens de acesso
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginDto"
            example:
              email: "joao@example.com"
              password: "MinhaSenh@123"
      responses:
        "200":
          description: Login realizado com sucesso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthSuccessResponse"
              example:
                user:
                  id: "cmibv831y00035comthf3wzmk"
                  name: "João Silva"
                  email: "joao@example.com"
                  role: "USER"
                  createdAt: "2024-01-15T10:30:00Z"
                  updatedAt: "2024-01-15T10:30:00Z"
                accessToken: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                refreshToken: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                expiresIn: 900
        "401":
          description: Credenciais inválidas
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
              example:
                statusCode: 401
                message: "Invalid credentials"
                error: "Unauthorized"
        "400":
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"

  /api/auth/refresh:
    post:
      tags:
        - Auth
      summary: Renovar access token
      description: Gera novo access token usando refresh token válido
      operationId: refresh
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshDto"
            example:
              refreshToken: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
      responses:
        "200":
          description: Token renovado com sucesso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenSuccessResponse"
              example:
                accessToken: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                expiresIn: 900
        "401":
          description: Refresh token inválido ou expirado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
              example:
                statusCode: 401
                message: "Invalid or expired refresh token"
                error: "Unauthorized"

  /api/auth/requestPasswordReset:
    post:
      tags:
        - Auth
      summary: Solicitar reset de senha
      description: |
        Gera um token de validação para reset de senha e envia por email (se configurado).
        Retorna o token gerado para uso imediato.
      operationId: requestPasswordReset
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RequestPasswordResetDto"
            example:
              email: "joao@example.com"
      responses:
        "200":
          description: Token de reset gerado com sucesso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RequestPasswordResetResponse"
              example:
                message: "Token de reset de senha gerado com sucesso"
                token: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2"
                expiresIn: 3600
        "400":
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"
              example:
                statusCode: 400
                message:
                  - "email must be an email"
                error: "Bad Request"

  /api/auth/resetPassword:
    post:
      tags:
        - Auth
      summary: Resetar senha
      description: |
        Valida o token de reset e atualiza a senha do usuário.
        O token deve ser válido e não expirado.
      operationId: resetPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ResetPasswordDto"
            example:
              token: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2"
              newPassword: "NovaSenh@123"
      responses:
        "200":
          description: Senha atualizada com sucesso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResetPasswordResponse"
              example:
                message: "Senha atualizada com sucesso"
                success: true
        "400":
          description: Token expirado ou dados inválidos
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
              example:
                statusCode: 400
                message: "Token de reset expirado"
                error: "Bad Request"
                timestamp: "2024-01-15T10:30:00Z"
                path: "/api/auth/resetPassword"
        "404":
          description: Token de reset inválido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
              example:
                statusCode: 404
                message: "Token de reset inválido"
                error: "Not Found"

  /api/users/me:
    get:
      tags:
        - Users
      summary: Obter perfil do usuário logado
      description: Retorna informações do usuário autenticado
      operationId: getProfile
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Perfil do usuário
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserSuccessResponse"
              example:
                id: "cmibv831y00035comthf3wzmk"
                name: "João Silva"
                email: "joao@example.com"
                role: "USER"
                createdAt: "2024-01-15T10:30:00Z"
                updatedAt: "2024-01-15T10:30:00Z"
        "401":
          description: Token inválido ou não fornecido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /api/users:
    get:
      tags:
        - Users
      summary: Listar usuários
      description: Lista todos os usuários (apenas administradores)
      operationId: getUsers
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          description: Número da página
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: Itens por página
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
        - name: email
          in: query
          description: Filtrar por email (busca parcial, case-insensitive)
          required: false
          schema:
            type: string
            example: "joao"
        - name: name
          in: query
          description: Filtrar por nome (busca parcial, case-insensitive)
          required: false
          schema:
            type: string
            example: "Maria"
        - name: role
          in: query
          description: Filtrar por papel do usuário
          required: false
          schema:
            type: string
            enum: [USER, ADMIN]
            example: "USER"
      responses:
        "200":
          description: Lista de usuários
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserListSuccessResponse"
              example:
                payload:
                  - id: "cmibv831y00035comthf3wzmk"
                    name: "João Silva"
                    email: "joao@example.com"
                    role: "USER"
                    createdAt: "2024-01-15T10:30:00Z"
                    updatedAt: "2024-01-15T10:30:00Z"
                  - id: "cmibv831y00036comthf3wzml"
                    name: "Maria Santos"
                    email: "maria@example.com"
                    role: "ADMIN"
                    createdAt: "2024-01-15T11:00:00Z"
                    updatedAt: "2024-01-15T11:00:00Z"
                meta:
                  page: 1
                  limit: 10
                  total: 2
                  totalPages: 1
        "401":
          description: Token inválido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "403":
          description: Acesso negado - apenas administradores
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
              example:
                statusCode: 403
                message: "Insufficient permissions"
                error: "Forbidden"

  /api/users/admin:
    post:
      tags:
        - Users
      summary: Criar novo usuário
      description: Cria um novo usuário no sistema (apenas administradores)
      operationId: createUser
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterDto"
            example:
              name: "João Silva"
              email: "joao@example.com"
              password: "MinhaSenh@123"
              role: "USER"
      responses:
        "201":
          description: Usuário criado com sucesso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserSuccessResponse"
              example:
                id: "cmibv831y00035comthf3wzmk"
                name: "João Silva"
                email: "joao@example.com"
                role: "USER"
                createdAt: "2024-01-15T10:30:00Z"
                updatedAt: "2024-01-15T10:30:00Z"
        "400":
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"
        "401":
          description: Token inválido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "403":
          description: Acesso negado - apenas administradores
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "409":
          description: Email já cadastrado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
              example:
                statusCode: 409
                message: "Email already exists"
                error: "Conflict"

  /api/users/{id}:
    get:
      tags:
        - Users
      summary: Obter usuário por ID
      description: Busca usuário específico (admin ou próprio usuário)
      operationId: getUserById
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: ID do usuário
          schema:
            type: string
      responses:
        "200":
          description: Dados do usuário
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserSuccessResponse"
              example:
                id: "cmibv831y00035comthf3wzmk"
                name: "João Silva"
                email: "joao@example.com"
                role: "USER"
                createdAt: "2024-01-15T10:30:00Z"
                updatedAt: "2024-01-15T10:30:00Z"
        "401":
          description: Token inválido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "403":
          description: Acesso negado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: Usuário não encontrado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
              example:
                statusCode: 404
                message: "User not found"
                error: "Not Found"

  /api/users/admin/{id}:
    patch:
      tags:
        - Users
      summary: Atualizar usuário
      description: Atualiza dados do usuário (apenas administradores)
      operationId: updateUser
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: ID do usuário
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateUserDto"
            example:
              name: "João Silva Santos"
              email: "joao.santos@example.com"
              password: "NovaSenh@456"
              role: "ADMIN"
      responses:
        "200":
          description: Usuário atualizado com sucesso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserSuccessResponse"
              example:
                id: "cmibv831y00035comthf3wzmk"
                name: "João Silva Santos"
                email: "joao.santos@example.com"
                role: "USER"
                createdAt: "2024-01-15T10:30:00Z"
                updatedAt: "2024-01-15T12:30:00Z"
        "400":
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"
        "401":
          description: Token inválido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "403":
          description: Acesso negado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: Usuário não encontrado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "409":
          description: Email já em uso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

    delete:
      tags:
        - Users
      summary: Excluir usuário
      description: Remove usuário do sistema (apenas administradores)
      operationId: deleteUser
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: ID do usuário
          schema:
            type: string
      responses:
        "204":
          description: Usuário excluído com sucesso
        "401":
          description: Token inválido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "403":
          description: Acesso negado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: Usuário não encontrado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT access token obtido através do endpoint `/api/auth/login` ou `/api/auth/register`.

        **Formato:** `Authorization: Bearer <access_token>`

        **Duração:** 15 minutos

        **Renovação:** Use `/api/auth/refresh` com o refresh token

  schemas:
    # Schema base para respostas de sucesso
    ApiResponse:
      type: object
      properties:
        payload:
          type: object
          description: Dados da resposta
        meta:
          type: object
          description: Metadados adicionais (opcional)
          properties:
            timestamp:
              type: string
              format: date-time
              description: Timestamp da resposta
              example: "2024-01-15T10:30:00Z"
            requestId:
              type: string
              description: ID único da requisição
              example: "req_123456789"
    # DTOs de entrada
    RegisterDto:
      type: object
      required:
        - name
        - email
        - password
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 100
          description: Nome completo do usuário
          example: "João Silva"
        email:
          type: string
          format: email
          description: Endereço de email único
          example: "joao@example.com"
        password:
          type: string
          minLength: 8
          maxLength: 128
          pattern: '^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]'
          description: |
            Senha forte contendo:
            - Mínimo 8 caracteres
            - Pelo menos 1 letra minúscula
            - Pelo menos 1 letra maiúscula
            - Pelo menos 1 número
            - Pelo menos 1 caractere especial
          example: "MinhaSenh@123"
        role:
          type: string
          enum: [USER, ADMIN]
          default: USER
          description: Papel do usuário no sistema
          example: "USER"

    LoginDto:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: Email cadastrado
          example: "joao@example.com"
        password:
          type: string
          description: Senha do usuário
          example: "MinhaSenh@123"

    RefreshDto:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string
          description: Refresh token válido obtido no login
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

    RequestPasswordResetDto:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: Email do usuário para reset de senha
          example: "joao@example.com"

    ResetPasswordDto:
      type: object
      required:
        - token
        - newPassword
      properties:
        token:
          type: string
          description: Token de reset obtido através do endpoint de solicitação
          example: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2"
        newPassword:
          type: string
          minLength: 8
          maxLength: 128
          pattern: '^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]'
          description: |
            Nova senha forte contendo:
            - Mínimo 8 caracteres
            - Pelo menos 1 letra minúscula
            - Pelo menos 1 letra maiúscula
            - Pelo menos 1 número
            - Pelo menos 1 caractere especial
          example: "NovaSenh@123"

    UpdateUserDto:
      type: object
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 100
          description: Nome completo do usuário
          example: "João Silva Santos"
        email:
          type: string
          format: email
          description: Novo endereço de email
          example: "joao.santos@example.com"
        password:
          type: string
          minLength: 8
          maxLength: 128
          pattern: '^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]'
          description: Nova senha (opcional)
          example: "NovaSenh@456"
        role:
          type: string
          enum: [USER, ADMIN]
          description: Papel do usuário no sistema (opcional)
          example: "ADMIN"

    # Schemas de resposta
    AuthSuccessResponse:
      type: object
      properties:
        user:
          $ref: "#/components/schemas/UserProfile"
        accessToken:
          type: string
          description: JWT access token para autenticação
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        refreshToken:
          type: string
          description: Refresh token para renovação
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        expiresIn:
          type: integer
          description: Tempo de expiração do access token em segundos
          example: 900

    TokenSuccessResponse:
      type: object
      properties:
        accessToken:
          type: string
          description: Novo JWT access token
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        expiresIn:
          type: integer
          description: Tempo de expiração em segundos
          example: 900

    RequestPasswordResetResponse:
      type: object
      properties:
        message:
          type: string
          description: Mensagem de confirmação
          example: "Token de reset de senha gerado com sucesso"
        token:
          type: string
          description: Token de reset gerado (64 caracteres hexadecimais)
          example: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2"
        expiresIn:
          type: integer
          description: Tempo de expiração do token em segundos
          example: 3600

    ResetPasswordResponse:
      type: object
      properties:
        message:
          type: string
          description: Mensagem de confirmação
          example: "Senha atualizada com sucesso"
        success:
          type: boolean
          description: Indica se a operação foi bem-sucedida
          example: true

    UserSuccessResponse:
      $ref: "#/components/schemas/UserProfile"

    UserListSuccessResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            payload:
              type: array
              items:
                $ref: "#/components/schemas/UserProfile"
            meta:
              $ref: "#/components/schemas/PaginationMeta"

    # Entidades de resposta
    UserProfile:
      type: object
      properties:
        id:
          type: string
          description: Identificador único do usuário (cuid)
          example: "cmibv831y00035comthf3wzmk"
        name:
          type: string
          description: Nome completo
          example: "João Silva"
        email:
          type: string
          format: email
          description: Endereço de email
          example: "joao@example.com"
        role:
          type: string
          enum: [USER, ADMIN]
          description: Papel no sistema
          example: "USER"
        createdAt:
          type: string
          format: date-time
          description: Data de criação da conta
          example: "2024-01-15T10:30:00Z"
        updatedAt:
          type: string
          format: date-time
          description: Data da última atualização
          example: "2024-01-15T10:30:00Z"

    PaginationMeta:
      type: object
      properties:
        page:
          type: integer
          description: Página atual
          example: 1
        limit:
          type: integer
          description: Itens por página
          example: 10
        total:
          type: integer
          description: Total de itens
          example: 25
        totalPages:
          type: integer
          description: Total de páginas
          example: 3

    # Schemas de erro
    ApiError:
      type: object
      properties:
        statusCode:
          type: integer
          description: Código de status HTTP
          example: 400
        message:
          type: string
          description: Mensagem de erro
          example: "Invalid input data"
        error:
          type: string
          description: Tipo do erro
          example: "Bad Request"
        timestamp:
          type: string
          format: date-time
          description: Timestamp do erro
          example: "2024-01-15T10:30:00Z"
        path:
          type: string
          description: Endpoint que gerou o erro
          example: "/api/auth/login"

    ValidationError:
      type: object
      properties:
        statusCode:
          type: integer
          example: 400
        message:
          type: array
          items:
            type: string
          description: Lista de erros de validação
          example:
            - "email must be a valid email"
            - "password must be longer than or equal to 8 characters"
        error:
          type: string
          example: "Bad Request"
